import sqlite3
import os
from datetime import datetime  # 追加

def generate_html():
    conn = sqlite3.connect('game_data.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM characters')
    characters = cursor.fetchall()
    
    last_updated = datetime.now().strftime('%Y-%m-%d %H:%M:%S')  # 追加

    html_content = f'''
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>アイドルリスト for IDOLY PRIDE</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" href="icon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" href="icon.ico">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9647262951514669" crossorigin="anonymous"></script>
        <meta name="google-adsense-account" content="ca-pub-9647262951514669">
    </head>
    <body>
        <div class="banner">
            アイドルリスト for IDOLY PRIDE
            <div class="menu">⋮</div>
            <div class="menu-content">
                <a href="#">つかいかた</a>
                <a href="#">このツールについて</a>
                <a href="#" id="possession-info">所持アイドルチェックについて</a>
                <div class="separator"></div>
                <a href="#" id="possession-check">所持アイドルチェック</a>
                <a href="#" id="possession-export">エクスポート</a>
                <a href="#" id="possession-import">インポート</a>
            </div>
        </div>
        <div class="last-updated">最終更新日時: {last_updated}</div>  <!-- 追加 -->
        <div class="popup">
            <div class="popup-header"></div>
            <div class="popup-content"></div>
            <button class="popup-close">閉じる</button>
        </div>
        <div class="container">
            <div class="filters">
                <h2>フィルタ</h2>
                <form id="filter-form">
                    <div>
                        <h3>キャラ</h3>
                        <select name="character">
                            <option value="">すべて</option>
                            <option value="長瀬琴乃">長瀬琴乃</option>
                            <option value="伊吹渚">伊吹渚</option>
                            <option value="白石沙季">白石沙季</option>
                            <option value="成宮すず">成宮すず</option>
                            <option value="早坂芽衣">早坂芽衣</option>
                            <option value="川咲さくら">川咲さくら</option>
                            <option value="兵藤雫">兵藤雫</option>
                            <option value="白石千紗">白石千紗</option>
                            <option value="一ノ瀬怜">一ノ瀬怜</option>
                            <option value="佐伯遙子">佐伯遙子</option>
                            <option value="天動瑠依">天動瑠依</option>
                            <option value="鈴村優">鈴村優</option>
                            <option value="奥山すみれ">奥山すみれ</option>
                            <option value="神崎莉央">神崎莉央</option>
                            <option value="井川葵">井川葵</option>
                            <option value="小美山愛">小美山愛</option>
                            <option value="赤崎こころ">赤崎こころ</option>
                            <option value="fran">fran</option>
                            <option value="kana">kana</option>
                            <option value="miho">miho</option>
                            <option value="長瀬麻奈">長瀬麻奈</option>
                        </select>
                    </div>
                    <div>
                        <h3>初期レアリティ</h3>
                        <label><input type="checkbox" name="rarity" value="★1">★1</label>
                        <label><input type="checkbox" name="rarity" value="★2">★2</label>
                        <label><input type="checkbox" name="rarity" value="★3">★3</label>
                        <label><input type="checkbox" name="rarity" value="★4">★4</label>
                        <label><input type="checkbox" name="rarity" value="★5">★5</label>
                    </div>
                    <div>
                        <h3>入手方法</h3>
                        <select name="obtain">
                            <option value="">すべて</option>
                            <option value="恒常">恒常</option>
                            <option value="限定">限定</option>
                            <option value="フェス">フェス</option>
                            <option value="誕生日">誕生日</option>
                            <option value="プレミアム">プレミアム</option>
                            <option value="コラボ">コラボ</option>
                            <option value="イベント">イベント</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    <div>
                        <h3>傾向</h3>
                        <label><input type="checkbox" name="trend" value="ボーカル">ボーカル</label>
                        <label><input type="checkbox" name="trend" value="ダンス">ダンス</label>
                        <label><input type="checkbox" name="trend" value="ビジュアル">ビジュアル</label>
                    </div>
                    <div>
                        <h3>タイプ</h3>
                        <label><input type="checkbox" name="type" value="スコアラー">スコアラー</label>
                        <label><input type="checkbox" name="type" value="バッファー">バッファー</label>
                        <label><input type="checkbox" name="type" value="サポーター">サポーター</label>
                    </div>
                    <div>
                        <h3>スキル構成</h3>
                        <label><input type="checkbox" name="skill" value="SP所持">SP所持</label>
                        <label><input type="checkbox" name="skill" value="SP未所持">SP未所持</label>
                        <label><input type="checkbox" name="skill" value="AA">AA</label>
                    </div>
                    <div>
                        <h3>エール</h3>
                        <select name="support">
                            <option value="">すべて</option>
                            <option value="なし">なし</option>
                            <option value="ボーカルアップ">ボーカルアップ</option>
                            <option value="ダンスアップ">ダンスアップ</option>
                            <option value="ビジュアルアップ">ビジュアルアップ</option>
                            <option value="スタミナアップ">スタミナアップ</option>
                            <option value="メンタルアップ">メンタルアップ</option>
                            <option value="クリティカルアップ">クリティカルアップ</option>
                            <option value="ビートスコアアップ">ビートスコアアップ</option>
                            <option value="Aスコアアップ">Aスコアアップ</option>
                            <option value="SPスコアアップ">SPスコアアップ</option>
                            <option value="クリティカルスコアアップ">クリティカルスコアアップ</option>
                            <option value="MEXPアップ【自主トレ】">MEXPアップ【自主トレ】</option>
                            <option value="コインアップ【自主トレ】">コインアップ【自主トレ】</option>
                            <option value="レッスンピースアップ【自主トレ】">レッスンピースアップ【自主トレ】</option>
                            <option value="MEXPアップ【ファンイベント】">MEXPアップ【ファンイベント】</option>
                            <option value="MEXPアップ【プロモーション】">MEXPアップ【プロモーション】</option>
                            <option value="コインアップ【プロモーション】">コインアップ【プロモーション】</option>
                            <option value="アクセサリアップ">アクセサリアップ</option>
                            <option value="元気回復アップ">元気回復アップ</option>
                        </select>
                    </div>
                    <div>
                        <h3>所持アイドル</h3>
                        <label><input type="checkbox" name="possession" value="所持">所持アイドルのみ表示</label>
                    </div>
                    <div>
                        <h2>並び替え</h2>
                        <label><input type="radio" name="sort" value="ボーカル">ボーカル</label>
                        <label><input type="radio" name="sort" value="ダンス">ダンス</label>
                        <label><input type="radio" name="sort" value="ビジュアル">ビジュアル</label>
                        <label><input type="radio" name="sort" value="スタミナ">スタミナ</label>
                    </div>
                    <div>
                        <h2>キーワード検索</h2>
                        <input type="text" name="keyword" placeholder="キーワードを入力">
                    </div>
                    <button type="button" onclick="applyFilters()">適用</button>
                    <button type="button" class="reset" onclick="resetFilters()">全てリセット</button>
                </form>
            </div>
            <div class="table-container">
                <table id="character-table">
                    <tr>
                        <th class="hidden">ID</th>
                        <th class="hidden">キャラ</th>
                        <th>アイドル名</th>
                        <th class="hidden">初期レアリティ</th>
                        <th>傾向</th>
                        <th>タイプ</th>
                        <th class="hidden">スキル構成</th>
                        <th class="hidden">衣装</th>
                        <th>ボーカル</th>
                        <th>ダンス</th>
                        <th>ビジュアル</th>
                        <th>スタミナ</th>
                        <th class="hidden">ライブスキル1名前</th>
                        <th class="hidden">ライブスキル1効果</th>
                        <th class="hidden">ライブスキル2名前</th>
                        <th class="hidden">ライブスキル2効果</th>
                        <th class="hidden">ライブスキル3名前</th>
                        <th class="hidden">ライブスキル3効果</th>
                        <th>エール</th>
                        <th class="hidden">入手方法</th>
                        <th class="hidden">実装日</th>
                    </tr>
    '''
    
    for character in characters:
        html_content += '<tr>'
        for i, item in enumerate(character):
            if i == 2:  # アイドル名の列
                card_name_with_image = f'<img src="images\{character[1]} {item}.png" width="50" alt="{item} {character[1]}"><br><a href="details/{character[1]} {item}.html">{item} {character[1]}</a>'
                html_content += f'<td>{card_name_with_image}</td>'
            elif i in [0, 1, 3, 6, 7, 12, 13, 14, 15, 16, 17, 19, 20]:
                html_content += f'<td class="hidden">{item}</td>'
            else:
                html_content += f'<td>{item}</td>'
        html_content += '</tr>'
    
    html_content += '''
                </table>
            </div>
        </div>
        <div class="possession-buttons" style="display: none;">
            <button onclick="savePossession()">保存</button>
            <button class="select-all" onclick="selectAllPossession()">全て選択</button>
        </div>
        <div class="export-popup">
            <textarea readonly></textarea>
            <button class="copy">コピー</button>
            <button class="close">閉じる</button>
        </div>
        <div class="import-popup">
            <textarea></textarea>
            <button class="save">読み込む</button>
            <button class="close">閉じる</button>
        </div>
        <button id="scrollToTopBtn" onclick="scrollToTop()">ページ上部へ</button>
        <script src="script.js"></script>
    </body>
    </html>
    '''
    
    with open('index.html', 'w', encoding='utf-8') as file:
        file.write(html_content)
    
    generate_detail_pages(characters)  # 追加

    conn.close()

def generate_detail_pages(characters):
    for character in characters:
        detail_content = f'''
        <!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{character[2]} {character[1]}</title>
            <link rel="stylesheet" href="../style.css">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9647262951514669" crossorigin="anonymous"></script>
            <meta name="google-adsense-account" content="ca-pub-9647262951514669">
        </head>
        <body>
            <div class="banner">
                アイドルリスト for IDOLY PRIDE
                <div class="menu">⋮</div>
                <div class="menu-content">
                    <a href="../index.html">戻る</a>
                </div>
            </div>
            <div class="container">
                <h1>{character[2]} {character[1]}</h1>
                <img src="../images/{character[1]} {character[2]}.png" alt="{character[2]} {character[1]}">
                <table>
                    <tr><th>ID</th><td>{character[0]}</td></tr>
                    <tr><th>キャラ</th><td>{character[1]}</td></tr>
                    <tr><th>アイドル名</th><td>{character[2]}</td></tr>
                    <tr><th>初期レアリティ</th><td>{character[3]}</td></tr>
                    <tr><th>傾向</th><td>{character[4]}</td></tr>
                    <tr><th>タイプ</th><td>{character[5]}</td></tr>
                    <tr><th>スキル構成</th><td>{character[6]}</td></tr>
                    <tr><th>衣装</th><td>{character[7]}</td></tr>
                    <tr><th>ボーカル</th><td>{character[8]}</td></tr>
                    <tr><th>ダンス</th><td>{character[9]}</td></tr>
                    <tr><th>ビジュアル</th><td>{character[10]}</td></tr>
                    <tr><th>スタミナ</th><td>{character[11]}</td></tr>
                    <tr><th>ライブスキル1名前</th><td>{character[12]}</td></tr>
                    <tr><th>ライブスキル1効果</th><td>{character[13]}</td></tr>
                    <tr><th>ライブスキル2名前</th><td>{character[14]}</td></tr>
                    <tr><th>ライブスキル2効果</th><td>{character[15]}</td></tr>
                    <tr><th>ライブスキル3名前</th><td>{character[16]}</td></tr>
                    <tr><th>ライブスキル3効果</th><td>{character[17]}</td></tr>
                    <tr><th>エール</th><td>{character[18]}</td></tr>
                    <tr><th>入手方法</th><td>{character[19]}</td></tr>
                    <tr><th>実装日</th><td>{character[20]}</td></tr>
                </table>
            </div>
        </body>
        </html>
        '''
        
        os.makedirs('details', exist_ok=True)
        filename = f'details/{character[1]} {character[2]}.html'.replace('\n', '')
        with open(filename, 'w', encoding='utf-8') as file:
            file.write(detail_content)

if __name__ == "__main__":
    generate_html()
